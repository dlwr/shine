# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

SHINE is a comprehensive movie database project designed to be the world's most organized movie database. It collects and organizes movie information, awards, nominations, and multilingual translations. The project is built on Cloudflare Workers with Turso (libSQL) database and uses a modular architecture with separate packages for API, scrapers, database, and frontend.

## Architecture

The project uses a simplified monorepo structure with pnpm workspaces:

- **api/** - Hono-based REST API running on Cloudflare Workers
- **scrapers/** - CLI-based data collection tools (Wikipedia, TMDb, Cannes Film Festival, Academy Awards) 
- **front/** - Astro-based frontend (Cloudflare Pages)
- **src/** - Shared database schemas, migrations, and utilities

Key design patterns:
- Date-seeded movie selection (daily/weekly/monthly) with deterministic hash-based randomization, persisted in database
- Multilingual support through a flexible translations table
- Comprehensive awards and nominations tracking system
- UUID-based primary keys with snake_case database naming
- Database: Turso (libSQL) - a SQLite-compatible edge database

## Common Commands

### Development
```bash
# Start both API and frontend development servers
pnpm run dev

# Start API development server with local DB persistence
pnpm run api:dev

# Start frontend development server  
pnpm run front:dev

# Run scrapers (CLI tools)
pnpm run scrapers:academy-awards
pnpm run scrapers:cannes-film-festival [year]  # Optional year parameter
pnpm run scrapers:japanese-translations
pnpm run scrapers:movie-posters
pnpm run scrapers:movie-import
```

### Database Operations
```bash
# Development database commands
pnpm run db:studio
pnpm run db:generate
pnpm run db:migrate
pnpm run db:push

# Production database commands
pnpm run db:studio:prod
pnpm run db:generate:prod
pnpm run db:migrate:prod
pnpm run db:push:prod
```

### Deployment
```bash
# Deploy API to development environment
pnpm run api:deploy:dev

# Deploy API to production environment
pnpm run api:deploy:prod

# Deploy frontend to Cloudflare Pages
pnpm run front:deploy

# Note: Scrapers run locally as CLI tools and are not deployed
```

### Utilities
```bash
# Lint code
npx eslint .

# Format code  
npx prettier --write .
```

## Database Schema

The core entities follow this relationship structure:

```
movies ←→ translations (movie titles/descriptions)
  ↓ 1:N     ↓ 1:N
nominations  movie_selections (daily/weekly/monthly picks)
  ↓ N:1         ↓ 1:N
award_categories  poster_urls
  ↓ N:1
award_organizations
  ↓ 1:N
award_ceremonies
```

Important schema details:
- All tables use UUID primary keys generated by `generateUUID()` utility
- **`translations` table structure**:
  - `resourceType` must be `"movie_title"` for movie titles (NOT `"movie"`)
  - `content` field contains the raw title text directly (NOT formatted like `"title:Movie Name"`)
  - Composite unique constraint on `(resourceType, resourceUid, languageCode)`
  - Movie titles are NOT stored in the movies table itself - they must be in translations
- Database uses snake_case naming convention (configured in drizzle.config.ts)
- Date-seeded movie selection uses deterministic hash-based algorithms with persistence in `movie_selections` table

## Database Configuration

The project uses Turso (libSQL) as the database with separate databases for development and production. Configuration requires:

**Development Environment:**
- `TURSO_DATABASE_URL`: Your development Turso database URL
- `TURSO_AUTH_TOKEN`: Your development Turso authentication token

**Production Environment:**
- `TURSO_DATABASE_URL_PROD`: Your production Turso database URL  
- `TURSO_AUTH_TOKEN_PROD`: Your production Turso authentication token

**Admin Authentication:**
- `ADMIN_PASSWORD`: Admin password for login
- `JWT_SECRET`: Secret key for JWT token generation (uses `jose` library)

**External APIs (for scrapers):**
- `TMDB_API_KEY`: TMDb API key for movie data
- `TMDB_LEAD_ACCESS_TOKEN`: TMDb access token
- `OMDB_API_KEY`: OMDb API key for additional movie data

For local development with Cloudflare Workers:
1. Copy `.dev.vars.example` to `.dev.vars` in the root directory
2. Add your Turso credentials and API keys
3. The `.dev.vars` file is automatically symlinked to `api/` and `scrapers/` directories
4. Environment variables are loaded automatically by wrangler during development

For production deployment, set secrets using:
```bash
wrangler secret put TURSO_AUTH_TOKEN_PROD --env production
wrangler secret put ADMIN_PASSWORD --env production
wrangler secret put JWT_SECRET --env production
```

## Data Collection Strategy

Scrapers are CLI-based tools that run locally and follow this priority order:
1. Wikipedia (primary source for basic info and awards)
2. TMDb (The Movie Database - for Japanese translations and poster URLs)
3. Cannes Film Festival (official selections and awards)
4. Academy Awards (Oscar nominations and wins)
5. OMDb (planned for additional movie data)

Scraping features:
- Cheerio for HTML parsing with error handling and retry logic
- Command-line arguments support (e.g., specific year for Cannes scraper)
- Incremental updates to avoid duplicate data
- Integration with TMDb API for enriched movie data
- Automatic poster URL and translation fetching

## API Design

The main API endpoint (`/`) returns date-seeded movie selections:
- Daily: Changes every day
- Weekly: Changes every Friday (week starts Friday)
- Monthly: Changes every month

Movie selection features:
- Hash-based seeding ensures deterministic but varied results
- Selections are persisted in the `movie_selections` table
- Existing selections are reused to maintain consistency
- Fallback to hash-based selection if no movies match criteria

### Public API Endpoints

- `GET /` - Get date-seeded movie selections (daily/weekly/monthly)
- `GET /movies/:id` - Get movie details with all translations

### Admin API Endpoints

Authentication is handled via JWT tokens (using `jose` library) stored in localStorage (client-side only):
- `POST /auth/login` - Login with admin password
- `GET /admin/movies` - List all movies (paginated)
- `POST /movies/:id/translations` - Add or update movie translation
- `DELETE /movies/:id/translations/:lang` - Delete movie translation
- `DELETE /admin/movies/:id` - Delete movie and all related data (nominations, translations, posters, selections)
- `POST /reselect` - Force new movie selection for a specific period

### Admin Frontend Routes

Admin interface pages (authentication required via localStorage token):
- `/admin/login` - Admin login page
- `/admin/movies` - Movies list with pagination
- `/admin/movies/:id` - Edit movie details and translations

Note: Authentication uses localStorage, not cookies, so server-side auth checks in Astro pages won't work.

## Code Style and Conventions

- TypeScript with strict configuration
- ESLint with recommended + strict + unicorn rules
- Prettier for formatting with import organization
- No comments in code unless explicitly requested
- Follow existing patterns for database queries and API responses
- Use existing utilities and libraries (Hono, Drizzle, Cheerio)

## Important Files

- `src/schema/index.ts` - Database schema definitions
- `api/src/index.ts` - Main API implementation with date-seeding logic
- `drizzle.config.ts` - Database configuration for Turso
- `.dev.vars.example` - Environment variable template
- `.dev.vars` - Local development variables (symlinked to `api/` and `scrapers/`)
- `src/schema/movie-selections.ts` - Movie selection persistence schema
- `scrapers/src/japanese-translations/` - TMDb integration for translations
- `scrapers/src/cannes-film-festival.ts` - Cannes scraper with year parameter support

## Recent Changes Log

Track recent changes and updates to keep CLAUDE.md synchronized with the codebase.

### 2025-01-10
- Updated CLAUDE.md to reflect current project state
- Added movie_selections table documentation
- Updated scraper commands (TMDb, Cannes Film Festival integration)
- Fixed environment variable names (removed _DEV suffix)
- Added missing API endpoints documentation
- Updated file paths to match current structure
- Added `pnpm run dev` command to start both API and frontend concurrently

### 2025-06-10
- Improved `/admin/movies` page with better sorting and poster display:
  - Changed default sort order to `created_at DESC` (newest movies first)
  - Modified poster display to show only one poster per movie instead of multiple
- Added movie deletion functionality:
  - New `DELETE /admin/movies/:id` API endpoint with cascading delete of all related data
  - Added delete button with confirmation dialog in admin movies list
  - Proper cleanup of movie_selections, nominations, translations, and poster_urls
- Fixed `/admin/movies` API endpoint bug:
  - Corrected SQL ORDER BY clause to use proper camelCase column name `createdAt` instead of snake_case `created_at`
  - Used SQL template with schema field reference: `sql`${movies.createdAt} DESC`` at api/src/index.ts:581

### 2025-06-10 (Updated)
- Fixed API URL handling inconsistency:
  - Standardized all API URL construction to NOT include trailing slash in base URL
  - All API paths must start with leading slash (e.g., `/auth/login`, `/reselect`)
  - Fixed `Movies.astro` and `wrangler.jsonc` to follow this pattern
  - This prevents URL construction errors like `http://localhost:8787reselect`
- Fixed `/reselect` endpoint:
  - The endpoint expects `type` parameter, not `period`
  - Request body should include both `type` and `locale`
- Fixed movie import script (`movie-import-from-list.ts`):
  - Corrected `resourceType` to use `"movie_title"` instead of `"movie"`
  - Fixed `content` field to store raw title text instead of formatted strings
  - Resolved all ESLint errors (non-null assertions, null vs undefined, unused variables)

### Development Guidelines
- TSエラーとLintエラーをを絶対に無視するな
- Database column names in schema use camelCase (e.g., `createdAt`, `updatedAt`) but are mapped to snake_case in the actual database
- When writing SQL queries, use the schema field references directly instead of hardcoding column names
- **API URL Convention**: Base URLs should NOT have trailing slashes, paths should start with leading slash